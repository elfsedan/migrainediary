<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#4ecdc4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Migr√§ne üìä">
    <title>Migr√§ne üìä Eintr√§ge</title>
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="migraine-entries-rainbow.png">
    <link rel="icon" href="migraine-entries-rainbow.png">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWlncsOkbmUg8J+TiiBFaW50csOkZ2UiLCJzaG9ydF9uYW1lIjoiTWlncsOkbmUg8J+TiSIsImRlc2NyaXB0aW9uIjoiw5xiZXJzaWNodCDDvGJlciBNaWdyw6RuZS1FaW50csOkZ2UiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzRlY2RjNCIsInRoZW1lX2NvbG9yIjoiIzRlY2RjNCIsImljb25zIjpbeyJzcmMiOiJtaWdyYWluZS1lbnRyaWVzLXJhaW5ib3cucG5nIiwic2l6ZXMiOiIxODB4MTgwIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
            min-height: 100vh;
            padding: env(safe-area-inset-top, 20px) 20px env(safe-area-inset-bottom, 20px) 20px;
            user-select: none;
            -webkit-user-select: none;
            color: white;
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: calc(100vh - env(safe-area-inset-top, 40px) - env(safe-area-inset-bottom, 40px));
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header .stats {
            font-size: 14px;
            opacity: 0.9;
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            display: inline-block;
            margin-top: 10px;
        }

        .sync-status {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 10px 15px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .storage-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 10px 15px;
            margin-bottom: 20px;
            font-size: 12px;
        }

        .storage-type {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .storage-icon {
            width: 18px;
            height: 18px;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .last-update {
            opacity: 0.8;
            font-size: 10px;
            margin-top: 5px;
        }

        .summary-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            color: white;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .summary-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .summary-item p {
            font-size: 12px;
            opacity: 0.9;
        }

        .filter-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filter-tabs::-webkit-scrollbar {
            display: none;
        }

        .filter-tab {
            flex: 0 0 auto;
            min-width: 60px;
            max-width: 80px;
            padding: 8px 6px;
            border: none;
            border-radius: 16px;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filter-tab.active {
            background: white;
            color: #4ecdc4;
        }

        @media (max-width: 380px) {
            .filter-tab {
                font-size: 10px;
                padding: 6px 4px;
                min-width: 50px;
                max-width: 65px;
            }
        }

        @media (max-width: 320px) {
            .filter-tabs {
                gap: 4px;
            }
            
            .filter-tab {
                font-size: 9px;
                padding: 5px 3px;
                min-width: 45px;
                max-width: 55px;
            }
        }

        .content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .toolbar {
            padding: 20px 25px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .toolbar h2 {
            color: #333;
            font-size: 20px;
            margin: 0;
        }

        .toolbar-buttons {
            display: flex;
            gap: 8px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .export-btn {
            background: #4ecdc4;
            color: white;
        }

        .refresh-btn {
            background: #f0f0f0;
            color: #333;
        }

        .import-btn {
            background: #FFA500;
            color: white;
        }

        .sync-btn {
            background: #9b59b6;
            color: white;
        }

        @media (max-width: 380px) {
            .toolbar-btn {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .toolbar h2 {
                font-size: 18px;
            }
        }

        @media (max-width: 320px) {
            .toolbar {
                padding: 15px 20px 10px;
            }
            
            .toolbar-btn {
                padding: 4px 6px;
                font-size: 10px;
            }
            
            .toolbar h2 {
                font-size: 16px;
            }
        }

        .entries-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
        }

        .entry {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4ecdc4;
            transition: all 0.2s ease;
        }

        .entry:active {
            transform: scale(0.98);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .entry-date {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .entry-time {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .entry-actions button {
            padding: 5px 8px;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
            min-width: 28px;
        }

        .edit-btn {
            background: #ffd93d;
            color: #333;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
        }

        @media (max-width: 380px) {
            .entry-actions button {
                padding: 4px 6px;
                font-size: 9px;
                min-width: 24px;
            }
        }

        @media (max-width: 320px) {
            .entry-actions {
                gap: 4px;
            }
            
            .entry-actions button {
                padding: 3px 4px;
                font-size: 8px;
                min-width: 20px;
            }
        }

        .entry-details {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .detail-item {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .entry-relative-time {
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4ecdc4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .import-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .import-dialog {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .import-dialog h3 {
            color: #333;
            margin-bottom: 20px;
        }

        .file-input {
            margin: 20px 0;
            padding: 15px;
            border: 2px dashed #4ecdc4;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .import-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .import-btn-dialog {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
        }

        .sync-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(138, 43, 226, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .sync-content {
            max-width: 300px;
        }

        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            display: inline-block;
        }

        @media (max-width: 480px) {
            .entry-details {
                flex-direction: column;
                gap: 10px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .summary-item h3 {
                font-size: 20px;
            }
            
            .summary-item p {
                font-size: 10px;
            }
        }

        @media (max-width: 360px) {
            .summary-grid {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            
            .summary-item h3 {
                font-size: 18px;
            }
            
            .summary-item p {
                font-size: 9px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header .stats {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Meine Eintr√§ge</h1>
            <div class="stats" id="statsDisplay">Lade Daten...</div>
        </div>

        <div class="sync-status" id="syncStatus">
            üîÑ IndexedDB wird geladen...
            <div class="last-update" id="lastUpdate"></div>
        </div>

        <div class="storage-info">
            <div class="storage-type">
                <div class="storage-icon">üóÑÔ∏è</div>
                <span>IndexedDB Speicher</span>
            </div>
            <div id="storageSize">0 KB</div>
        </div>

        <div class="summary-card" id="summaryCard" style="display: none;">
            <div class="summary-grid">
                <div class="summary-item">
                    <h3 id="totalCount">0</h3>
                    <p>Gesamt</p>
                </div>
                <div class="summary-item">
                    <h3 id="thisWeekCount">0</h3>
                    <p>Diese Woche</p>
                </div>
                <div class="summary-item">
                    <h3 id="mostCommonType">-</h3>
                    <p>H√§ufigste Art</p>
                </div>
            </div>
        </div>

        <div class="filter-tabs">
            <button class="filter-tab active" onclick="setFilter('all')">Alle</button>
            <button class="filter-tab" onclick="setFilter('migraene')">Migr√§ne</button>
            <button class="filter-tab" onclick="setFilter('aura-migraene')">Aura+M</button>
            <button class="filter-tab" onclick="setFilter('kopfschmerz')">Kopfschmerz</button>
            <button class="filter-tab" onclick="setFilter('aura')">Aura</button>
        </div>

        <div class="content">
            <div class="toolbar">
                <h2>Verlauf</h2>
                <div class="toolbar-buttons">
                    <button class="toolbar-btn refresh-btn" onclick="forceRefresh()">üîÑ</button>
                    <button class="toolbar-btn import-btn" onclick="showImportDialog()">üìÅ</button>
                    <button class="toolbar-btn sync-btn" onclick="showSyncDialog()">üì±</button>
                    <button class="toolbar-btn export-btn" onclick="exportData()">üì§</button>
                </div>
            </div>
            
            <div class="entries-container" id="entriesContainer">
                <div class="loading-spinner"></div>
            </div>
        </div>
    </div>

    <!-- Import Dialog -->
    <div class="import-overlay" id="importOverlay">
        <div class="import-dialog">
            <h3>üìÅ Backup importieren</h3>
            <p>W√§hle eine Backup-Datei aus deiner Files-App:</p>
            <div class="file-input">
                <input type="file" id="fileInput" accept=".json" style="display: none;">
                <button onclick="document.getElementById('fileInput').click()" style="background: #4ecdc4; color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer;">
                    üìÇ Datei ausw√§hlen
                </button>
                <div id="fileName" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
            </div>
            <div class="import-actions">
                <button class="import-btn-dialog" onclick="closeImportDialog()" style="background: #f0f0f0; color: #333;">Abbrechen</button>
                <button class="import-btn-dialog" onclick="importBackup()" style="background: #4ecdc4; color: white;" id="importConfirm" disabled>Importieren</button>
            </div>
        </div>
    </div>

    <!-- Sync Dialog -->
    <div class="sync-overlay" id="syncOverlay">
        <div class="sync-content">
            <h3>üì± Ger√§te-Sync</h3>
            <p>Scanne diesen QR-Code mit einem anderen Ger√§t:</p>
            <div class="qr-code" id="qrCode">
                QR-Code wird generiert...
            </div>
            <p style="font-size: 12px; opacity: 0.8;">
                Der QR-Code enth√§lt deine aktuellen Daten f√ºr den Transfer zwischen deinen Ger√§ten.
            </p>
            <button onclick="closeSyncDialog()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 20px; border-radius: 10px; margin-top: 20px; cursor: pointer;">
                Schlie√üen
            </button>
        </div>
    </div>

    <script>
        const DB_NAME = 'MigraineDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'entries';
        let db = null;
        let entries = [];
        let currentFilter = 'all';
        let lastLoadTime = 0;

        // IndexedDB Setup (same as quick entry app)
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB error:', request.error);
                    updateSyncStatus('‚ùå DB-Fehler');
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    updateSyncStatus('‚úÖ IndexedDB bereit');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('type', 'type', { unique: false });
                    }
                    
                    updateSyncStatus('üîÑ DB initialisiert');
                };
            });
        }

        // Haptic feedback
        function vibrate(pattern = 10) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Enhanced localStorage operations
        function loadEntries(force = false) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const now = Date.now();
                if (!force && now - lastLoadTime < 2000) {
                    resolve(entries);
                    return;
                }

                updateSyncStatus('üîÑ Lade Daten...');

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const oldCount = entries.length;
                    entries = request.result || [];
                    entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    lastLoadTime = now;
                    
                    if (entries.length !== oldCount) {
                        if (entries.length > oldCount) {
                            updateSyncStatus(`‚úÖ ${entries.length - oldCount} neue Eintr√§ge geladen`);
                            vibrate([50, 100, 50]);
                        } else {
                            updateSyncStatus('‚úÖ Daten aktualisiert');
                        }
                    } else {
                        updateSyncStatus('‚úÖ Daten geladen');
                    }
                    
                    calculateStats();
                    renderEntries();
                    updateStorageSize();
                    resolve(entries);
                };

                request.onerror = () => {
                    updateSyncStatus('‚ùå Ladefehler');
                    reject(request.error);
                };
            });
        }

        function saveEntry(entry) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(entry);

                request.onsuccess = () => {
                    updateSyncStatus('‚úÖ Gespeichert');
                    resolve(request.result);
                };

                request.onerror = () => {
                    updateSyncStatus('‚ùå Speicherfehler');
                    reject(request.error);
                };
            });
        }

        function deleteEntryFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => {
                    updateSyncStatus('‚úÖ Eintrag gel√∂scht');
                    resolve();
                };

                request.onerror = () => {
                    updateSyncStatus('‚ùå L√∂schfehler');
                    reject(request.error);
                };
            });
        }

        function calculateStorageSize() {
            if (!entries || entries.length === 0) return 0;
            const dataStr = JSON.stringify(entries);
            return new Blob([dataStr]).size;
        }

        function updateStorageSize() {
            const size = calculateStorageSize();
            const sizeKB = (size / 1024).toFixed(1);
            document.getElementById('storageSize').textContent = `${sizeKB} KB`;
        }

        function updateSyncStatus(status) {
            document.getElementById('syncStatus').innerHTML = `
                ${status}
                <div class="last-update">Letztes Update: ${new Date().toLocaleTimeString()}</div>
            `;
            
            if (!status.includes('üîÑ')) {
                setTimeout(() => {
                    document.getElementById('syncStatus').innerHTML = `
                        üóÑÔ∏è IndexedDB Sync
                        <div class="last-update">Letztes Update: ${new Date().toLocaleTimeString()}</div>
                    `;
                }, 3000);
            }
        }

        // Format date and time with intelligence
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffTime / (1000 * 60));

            let dateText, timeText, relativeText;

            if (diffDays === 0) {
                dateText = 'Heute';
            } else if (diffDays === 1) {
                dateText = 'Gestern';
            } else if (diffDays < 7) {
                dateText = date.toLocaleDateString('de-DE', { weekday: 'long' });
            } else {
                dateText = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            }

            timeText = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            if (diffMinutes < 60) {
                relativeText = `vor ${diffMinutes} Min`;
            } else if (diffHours < 24) {
                relativeText = `vor ${diffHours} Std`;
            } else {
                relativeText = `vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
            }

            return { dateText, timeText, relativeText };
        }

        // Get type and medication labels
        function getTypeLabel(type) {
            const labels = {
                'kopfschmerz': 'ü§ï Kopfschmerz',
                'migraene': '‚ö° Migr√§ne',
                'aura': 'üëÅÔ∏è Aura',
                'aura-migraene': 'üåÄ Aura + Migr√§ne'
            };
            return labels[type] || type;
        }

        function getMedicationLabel(medication) {
            const labels = {
                'keine': '‚ùå Keine',
                'schmerzmittel': 'üíä Schmerzmittel',
                'triptan': 'üíâ Triptan'
            };
            return labels[medication] || medication;
        }

        // Calculate statistics
        function calculateStats() {
            if (entries.length === 0) {
                document.getElementById('summaryCard').style.display = 'none';
                document.getElementById('statsDisplay').textContent = 'Keine Eintr√§ge vorhanden';
                return;
            }

            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const thisWeekEntries = entries.filter(entry => 
                new Date(entry.timestamp) >= weekAgo
            );

            const typeCounts = {};
            entries.forEach(entry => {
                typeCounts[entry.type] = (typeCounts[entry.type] || 0) + 1;
            });

            let mostCommonType = '-';
            if (Object.keys(typeCounts).length > 0) {
                const mostCommon = Object.keys(typeCounts).reduce((a, b) => 
                    typeCounts[a] > typeCounts[b] ? a : b
                );
                mostCommonType = getTypeLabel(mostCommon).split(' ')[0];
            }

            document.getElementById('totalCount').textContent = entries.length;
            document.getElementById('thisWeekCount').textContent = thisWeekEntries.length;
            document.getElementById('mostCommonType').textContent = mostCommonType;
            document.getElementById('statsDisplay').textContent = 
                `${entries.length} Eintr√§ge ‚Ä¢ ${thisWeekEntries.length} diese Woche`;
            document.getElementById('summaryCard').style.display = 'block';
        }

        // Set filter
        function setFilter(filter) {
            vibrate();
            currentFilter = filter;
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderEntries();
        }

        // Enhanced render entries
        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            
            let filteredEntries = entries;
            if (currentFilter !== 'all') {
                filteredEntries = entries.filter(entry => entry.type === currentFilter);
            }

            if (filteredEntries.length === 0) {
                const filterText = currentFilter === 'all' ? '' : ` f√ºr "${getTypeLabel(currentFilter)}"`;
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <h3>Keine Eintr√§ge vorhanden${filterText}</h3>
                        <p>Nutze die Schnelleingabe-App ‚ö°</p>
                    </div>
                `;
                return;
            }

            const sortedEntries = filteredEntries.sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            container.innerHTML = sortedEntries.map(entry => {
                const { dateText, timeText, relativeText } = formatDateTime(entry.timestamp);
                
                return `
                    <div class="entry">
                        <div class="entry-header">
                            <div>
                                <div class="entry-date">${dateText}</div>
                                <div class="entry-time">${timeText}</div>
                            </div>
                            <div class="entry-actions">
                                <button class="edit-btn" onclick="editEntry(${entry.id})">‚úèÔ∏è</button>
                                <button class="delete-btn" onclick="deleteEntry(${entry.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="entry-details">
                            <div class="detail-item">
                                <div class="detail-label">Art</div>
                                <div class="detail-value">${getTypeLabel(entry.type)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Medikation</div>
                                <div class="detail-value">${getMedicationLabel(entry.medication)}</div>
                            </div>
                        </div>
                        <div class="entry-relative-time">${relativeText}</div>
                    </div>
                `;
            }).join('');
        }

        // Force refresh
        function forceRefresh() {
            vibrate();
            updateSyncStatus('üîÑ Manueller Refresh...');
            loadEntries(true);
        }

        // Delete entry
        async function deleteEntry(id) {
            if (confirm('Eintrag wirklich l√∂schen?')) {
                vibrate([20, 50, 20]);
                try {
                    await deleteEntryFromDB(id);
                    await loadEntries(true);
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('L√∂schen fehlgeschlagen.');
                }
            }
        }

        // Edit entry
        async function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            const types = ['kopfschmerz', 'migraene', 'aura', 'aura-migraene'];
            const medications = ['keine', 'schmerzmittel', 'triptan'];

            const newType = prompt(
                `Art √§ndern:\n1 = Kopfschmerz\n2 = Migr√§ne\n3 = Aura\n4 = Aura + Migr√§ne\n\nAktuell: ${getTypeLabel(entry.type)}`,
                types.indexOf(entry.type) + 1
            );

            if (newType && newType >= 1 && newType <= 4) {
                const newMed = prompt(
                    `Medikation √§ndern:\n1 = Keine\n2 = Schmerzmittel\n3 = Triptan\n\nAktuell: ${getMedicationLabel(entry.medication)}`,
                    medications.indexOf(entry.medication) + 1
                );

                if (newMed && newMed >= 1 && newMed <= 3) {
                    entry.type = types[newType - 1];
                    entry.medication = medications[newMed - 1];
                    
                    try {
                        await saveEntry(entry);
                        await loadEntries(true);
                        vibrate();
                    } catch (error) {
                        console.error('Edit error:', error);
                        alert('Bearbeiten fehlgeschlagen.');
                    }
                }
            }
        }

        // Export data
        function exportData() {
            if (entries.length === 0) {
                alert('Keine Daten zum Exportieren vorhanden.');
                return;
            }

            vibrate();

            try {
                const exportData = {
                    app: 'Migr√§ne Tagebuch',
                    version: '2.0',
                    exported: new Date().toISOString(),
                    entryCount: entries.length,
                    entries: entries
                };

                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `migraene-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                updateSyncStatus('üì§ Export erfolgreich');
                
            } catch (error) {
                console.error('Export error:', error);
                updateSyncStatus('‚ùå Export-Fehler');
            }
        }

        // Import functions
        function showImportDialog() {
            document.getElementById('importOverlay').style.display = 'flex';
        }

        function closeImportDialog() {
            document.getElementById('importOverlay').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('importConfirm').disabled = true;
        }

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('importConfirm').disabled = false;
            }
        });

        async function importBackup() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Bitte w√§hle eine Datei aus.');
                return;
            }

            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!data.entries || !Array.isArray(data.entries)) {
                    throw new Error('Invalid backup format');
                }

                const importCount = data.entries.length;
                if (confirm(`${importCount} Eintr√§ge importieren? Bestehende Daten bleiben erhalten.`)) {
                    
                    for (const entry of data.entries) {
                        // Ensure entry has required fields
                        if (!entry.id) entry.id = Date.now() + Math.random();
                        if (!entry.timestamp) entry.timestamp = new Date().toISOString();
                        
                        await saveEntry(entry);
                    }
                    
                    await loadEntries(true);
                    updateSyncStatus(`üìÅ ${importCount} Eintr√§ge importiert`);
                    closeImportDialog();
                    vibrate([100, 50, 100, 50, 100]);
                }
                
            } catch (error) {
                console.error('Import error:', error);
                alert('Import fehlgeschlagen. √úberpr√ºfe die Datei.');
            }
        }

        // Sync functions
        function showSyncDialog() {
            document.getElementById('syncOverlay').style.display = 'flex';
            generateQRCode();
        }

        function closeSyncDialog() {
            document.getElementById('syncOverlay').style.display = 'none';
        }

        function generateQRCode() {
            try {
                const syncData = {
                    app: 'MigraineDiary',
                    timestamp: new Date().toISOString(),
                    entries: entries.slice(-10) // Last 10 entries for QR size limit
                };
                
                const dataStr = JSON.stringify(syncData);
                const dataUrl = `data:text/plain;base64,${btoa(dataStr)}`;
                
                document.getElementById('qrCode').innerHTML = `
                    <div style="font-size: 12px; color: #333; padding: 10px;">
                        üì± QR-Code f√ºr letzte ${Math.min(10, entries.length)} Eintr√§ge<br>
                        <small>Vollst√§ndige Sync √ºber Export/Import</small>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('qrCode').innerHTML = 'QR-Code Fehler';
            }
        }

        // Auto-refresh with intelligence
        let refreshInterval;
        function startAutoRefresh() {
            refreshInterval = setInterval(async () => {
                const currentCount = entries.length;
                await loadEntries();
                if (entries.length !== currentCount && entries.length > currentCount) {
                    updateSyncStatus(`üÜï ${entries.length - currentCount} neue Eintr√§ge`);
                }
            }, 3000); // Check every 3 seconds
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        }

        // Initialize app
        window.addEventListener('load', async function() {
            try {
                updateSyncStatus('üöÄ App startet...');
                await initDB();
                await loadEntries(true);
                startAutoRefresh();
                
                // Check for localStorage migration
                const oldData = localStorage.getItem('migraineEntries');
                if (oldData && entries.length === 0) {
                    try {
                        const oldEntries = JSON.parse(oldData);
                        for (const entry of oldEntries) {
                            await saveEntry(entry);
                        }
                        await loadEntries(true);
                        updateSyncStatus('üì¶ Migration abgeschlossen');
                        localStorage.removeItem('migraineEntries');
                    } catch (e) {
                        console.warn('Migration failed:', e);
                    }
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                updateSyncStatus('‚ùå Init-Fehler');
            }
        });

        // Pause auto-refresh when app is hidden
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                stopAutoRefresh();
            } else {
                updateSyncStatus('üîÑ App aktiviert');
                loadEntries(true);
                startAutoRefresh();
            }
        });

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>