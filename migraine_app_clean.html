<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff6b6b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Migr√§ne ‚ö°">
    <title>Migr√§ne ‚ö° Tagebuch</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top, 20px) 20px env(safe-area-inset-bottom, 20px) 20px;
            user-select: none;
            -webkit-user-select: none;
            color: white;
            transition: background 0.3s ease;
        }

        .bg-quick {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .bg-entries {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .timestamp {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 500;
        }

        .entries-count {
            font-size: 12px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entries-count:active {
            transform: scale(0.95);
        }

        .screen {
            display: none;
            flex: 1;
            animation: slideIn 0.3s ease-out;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .quick-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .quick-header h1 {
            font-size: 42px;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .quick-header p {
            font-size: 18px;
            opacity: 0.9;
        }

        .form-container {
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            padding: 40px 30px;
            color: #333;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .detailed-form {
            max-height: none;
        }

        .form-section {
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .form-section h3 {
            color: #333;
            font-size: 20px;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            text-align: center;
            border-radius: 10px;
            border: 2px solid #f0f0f0;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 18px;
            color: #333;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .trigger-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        @media (max-width: 480px) {
            .trigger-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .button-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 350px) {
            .button-group {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
        }

        .option-btn {
            padding: 16px 8px;
            border: 3px solid #f0f0f0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            touch-action: manipulation;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            line-height: 1.1;
            min-height: 80px;
            max-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            word-break: break-word;
            hyphens: auto;
        }

        .option-btn.small {
            min-height: 70px;
            max-height: 75px;
            font-size: 12px;
            padding: 10px 6px;
        }

        @media (max-width: 380px) {
            .option-btn {
                font-size: 12px;
                padding: 12px 6px;
                min-height: 75px;
            }
        }

        .option-btn:active {
            transform: scale(0.95);
        }

        .option-btn.selected {
            border-color: #ff6b6b;
            background: #ff6b6b;
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            transform: translateY(-2px);
        }

        /* Slider Styles */
        .slider-container {
            position: relative;
            margin: 15px 0;
        }

        .pain-slider,
        .duration-slider,
        .med-slider {
            width: 100%;
            height: 8px;
            border-radius: 20px;
            background: #f0f0f0;
            outline: none;
            -webkit-appearance: none;
        }

        .pain-slider::-webkit-slider-thumb,
        .duration-slider::-webkit-slider-thumb,
        .med-slider::-webkit-slider-thumb {
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ff6b6b;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        .slider-value {
            text-align: center;
            margin-top: 10px;
            font-size: 18px;
            font-weight: 700;
            color: #ff6b6b;
        }

        /* Toggle Button Styles */
        .toggle-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toggle-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .toggle-item span {
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .toggle-buttons {
            display: flex;
            gap: 5px;
        }

        .toggle-btn {
            padding: 8px 16px;
            border: 2px solid #dee2e6;
            border-radius: 20px;
            background: white;
            color: #6c757d;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 50px;
        }

        .toggle-btn.active {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: white;
        }

        /* Checkbox Styles */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        @media (max-width: 480px) {
            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            user-select: none;
        }

        .checkbox-item:hover {
            background: #e9ecef;
            transform: scale(1.02);
        }

        .checkbox-item input[type="checkbox"] {
            display: none;
        }

        .checkmark {
            font-size: 18px;
            opacity: 0.5;
            transition: all 0.2s ease;
        }

        .checkbox-item input[type="checkbox"]:checked + .checkmark {
            opacity: 1;
            transform: scale(1.2);
        }

        .checkbox-item:has(input[type="checkbox"]:checked) {
            background: #4ecdc4;
            border-color: #4ecdc4;
            color: white;
        }

        /* Medication details */
        .medication-details {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 15px;
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .medication-details.show {
            display: block !important;
            border-color: #4ecdc4;
            background: #f0fffe;
        }

        .save-btn {
            width: 100%;
            padding: 22px;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            box-shadow: 0 8px 20px rgba(76, 205, 196, 0.4);
            transition: all 0.3s ease;
            touch-action: manipulation;
            margin-top: auto;
            margin-bottom: 20px;
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #ccc;
            box-shadow: none;
        }

        .save-button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto;
            margin-bottom: 20px;
        }

        .quick-save-btn {
            width: 100%;
            padding: 18px;
            border: 2px solid #ff6b6b;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            background: white;
            color: #ff6b6b;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .quick-save-btn:active {
            transform: scale(0.98);
        }

        .quick-save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #f8f9fa;
            color: #ccc;
            border-color: #ccc;
        }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .quick-action-btn {
            padding: 12px 20px;
            border: 2px solid #4ecdc4;
            border-radius: 20px;
            background: #4ecdc4;
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(76, 205, 196, 0.3);
        }

        .quick-action-btn:hover {
            background: #44a08d;
            border-color: #44a08d;
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(76, 205, 196, 0.4);
        }

        .quick-action-btn:active {
            transform: scale(0.95);
        }

        .entries-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            gap: 10px;
        }

        .back-btn, .export-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .back-btn:active, .export-btn:active {
            transform: scale(0.95);
        }

        .entries-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .entries-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .entries-header .stats {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
        }

        .summary-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .summary-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .summary-item p {
            font-size: 12px;
            opacity: 0.9;
        }

        .filter-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filter-tabs::-webkit-scrollbar {
            display: none;
        }

        .filter-tab {
            flex: 0 0 auto;
            min-width: 60px;
            max-width: 80px;
            padding: 8px 6px;
            border: none;
            border-radius: 16px;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filter-tab.active {
            background: white;
            color: #4ecdc4;
        }

        .entries-content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 70vh;
        }

        .entries-toolbar {
            padding: 20px 25px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .entries-toolbar h3 {
            color: #333;
            font-size: 18px;
            margin: 0;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: #4ecdc4;
            color: white;
        }

        .entries-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
            -webkit-overflow-scrolling: touch;
        }

        .entry {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4ecdc4;
            transition: all 0.2s ease;
        }

        .entry:active {
            transform: scale(0.98);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .entry-date {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .entry-time {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .entry-actions button {
            padding: 5px 8px;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
            min-width: 28px;
        }

        .edit-btn {
            background: #ffd93d;
            color: #333;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
        }

        .entry-details {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .detail-item {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .entry-relative-time {
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(76, 175, 80, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }

        .success-content {
            font-size: 24px;
            font-weight: 700;
        }

        .success-content .icon {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
        }

        .form-group input[type="date"],
        .form-group input[type="time"] {
            flex: 1;
            padding: 12px;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            transition: border-color 0.2s ease;
        }

        .form-group input[type="date"]:focus,
        .form-group input[type="time"]:focus {
            border-color: #ff6b6b;
            outline: none;
        }

        .datetime-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        @media (max-width: 480px) {
            .entry-details {
                flex-direction: column;
                gap: 10px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            
            .toggle-item {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .toggle-item span {
                flex: none;
            }
            
            .datetime-input-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body class="bg-quick">
    <div class="container">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="timestamp" id="timestamp"></div>
            <div class="entries-count" id="entriesCount" onclick="showEntries()">üìä 0 Eintr√§ge</div>
        </div>

        <!-- Main Detailed Entry Screen (Default) -->
        <div class="screen active" id="detailedScreen">
            <div class="quick-header">
                <h1>üìã Migr√§ne Tagebuch</h1>
                <p>Attacke dokumentieren</p>
            </div>
            
            <div class="form-container detailed-form">
                <form id="detailedForm">
                    <!-- Basic Info -->
                    <div class="form-section">
                        <h3>Grunddaten</h3>
                        <div class="form-group">
                            <label>Art der Beschwerden:</label>
                            <div class="button-group">
                                <button type="button" class="option-btn" data-value="kopfschmerz">ü§ï<br>Kopf-<br>schmerz</button>
                                <button type="button" class="option-btn" data-value="migraene">‚ö°<br>Migr√§ne</button>
                                <button type="button" class="option-btn" data-value="aura">üëÅÔ∏è<br>Aura</button>
                                <button type="button" class="option-btn" data-value="aura-migraene">üåÄ<br>Aura+<br>Migr√§ne</button>
                            </div>
                            <input type="hidden" name="type" required>
                        </div>
                    </div>

                    <!-- Triggers -->
                    <div class="form-section">
                        <h3>Ausl√∂ser</h3>
                        <div class="form-group">
                            <label>Was k√∂nnte der Ausl√∂ser gewesen sein?</label>
                            <div class="button-group trigger-grid">
                                <button type="button" class="option-btn small" data-value="stress">üò∞<br>Stress/<br>Aufregung</button>
                                <button type="button" class="option-btn small" data-value="erholung">üòå<br>Erholungs-<br>phase</button>
                                <button type="button" class="option-btn small" data-value="schlaf">üò¥<br>Schlaf-<br>rhythmus</button>
                                <button type="button" class="option-btn small" data-value="menstruation">ü©∏<br>Mens-<br>truation</button>
                                <button type="button" class="option-btn small" data-value="personal">üë§<br>Pers√∂nliche<br>Ausl√∂ser</button>
                                <button type="button" class="option-btn small" data-value="unknown">‚ùì<br>Unbekannt</button>
                            </div>
                            <input type="hidden" name="trigger">
                        </div>
                    </div>

                    <!-- Pain Characteristics -->
                    <div class="form-section">
                        <h3>Schmerzcharakteristik</h3>
                        <div class="form-group">
                            <label>Schmerzst√§rke (1-10):</label>
                            <div class="slider-container">
                                <input type="range" id="painLevel" name="painLevel" min="1" max="10" value="5" class="pain-slider">
                                <div class="slider-value">
                                    <span id="painLevelValue">5</span>/10
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Dauer in Stunden:</label>
                            <div class="slider-container">
                                <input type="range" id="duration" name="duration" min="0.5" max="72" step="0.5" value="4" class="duration-slider">
                                <div class="slider-value">
                                    <span id="durationValue">4</span> Std
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Schmerzart:</label>
                            <div class="toggle-group">
                                <div class="toggle-item">
                                    <span>Pulsierend/Stechend:</span>
                                    <div class="toggle-buttons">
                                        <button type="button" class="toggle-btn" data-name="pulsating" data-value="yes">Ja</button>
                                        <button type="button" class="toggle-btn active" data-name="pulsating" data-value="no">Nein</button>
                                    </div>
                                </div>
                                <div class="toggle-item">
                                    <span>Dumpf/Dr√ºckend:</span>
                                    <div class="toggle-buttons">
                                        <button type="button" class="toggle-btn" data-name="pressing" data-value="yes">Ja</button>
                                        <button type="button" class="toggle-btn active" data-name="pressing" data-value="no">Nein</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="pulsating" value="no">
                            <input type="hidden" name="pressing" value="no">
                        </div>

                        <div class="form-group">
                            <label>Lokalisation:</label>
                            <div class="button-group">
                                <button type="button" class="option-btn small" data-value="left">‚Üê<br>Links<br>einseitig</button>
                                <button type="button" class="option-btn small" data-value="right">‚Üí<br>Rechts<br>einseitig</button>
                                <button type="button" class="option-btn small" data-value="both">‚Üî<br>Beid-<br>seitig</button>
                                <button type="button" class="option-btn small" data-value="other">‚Ä¢<br>Anders</button>
                            </div>
                            <input type="hidden" name="location">
                        </div>
                    </div>

                    <!-- Aura Symptoms -->
                    <div class="form-section">
                        <h3>Vorboten/Aura</h3>
                        <div class="form-group">
                            <label>Welche Vorboten hattest du?</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aura" value="flimmern">
                                    <span class="checkmark">‚ú®</span>
                                    Flimmersehen
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aura" value="gefuehl">
                                    <span class="checkmark">ü§ö</span>
                                    Gef√ºhlsst√∂rung (Kribbeln)
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aura" value="sprache">
                                    <span class="checkmark">üó£Ô∏è</span>
                                    Sprachst√∂rung
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="aura" value="andere">
                                    <span class="checkmark">‚ùì</span>
                                    Andere Symptome
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Accompanying Symptoms -->
                    <div class="form-section">
                        <h3>Begleitsymptome</h3>
                        <div class="form-group">
                            <div class="toggle-group">
                                <div class="toggle-item">
                                    <span>ü§Æ Erbrechen:</span>
                                    <div class="toggle-buttons">
                                        <button type="button" class="toggle-btn" data-name="vomiting" data-value="yes">Ja</button>
                                        <button type="button" class="toggle-btn active" data-name="vomiting" data-value="no">Nein</button>
                                    </div>
                                </div>
                                <div class="toggle-item">
                                    <span>ü§¢ √úbelkeit:</span>
                                    <div class="toggle-buttons">
                                        <button type="button" class="toggle-btn" data-name="nausea" data-value="yes">Ja</button>
                                        <button type="button" class="toggle-btn active" data-name="nausea" data-value="no">Nein</button>
                                    </div>
                                </div>
                                <div class="toggle-item">
                                    <span>üîä L√§rmscheu:</span>
                                    <div class="toggle-buttons">
                                        <button type="button" class="toggle-btn" data-name="phonophobia" data-value="yes">Ja</button>
                                        <button type="button" class="toggle-btn active" data-name="phonophobia" data-value="no">Nein</button>
                                    </div>
                                </div>
                                <div class="toggle-item">
                                    <span>üí° Lichtscheu:</span>
                                    <div class="toggle-buttons">
                                        <button type="button" class="toggle-btn" data-name="photophobia" data-value="yes">Ja</button>
                                        <button type="button" class="toggle-btn active" data-name="photophobia" data-value="no">Nein</button>
                                    </div>
                                </div>
                                <div class="toggle-item">
                                    <span>üëÉ Geruchsempfindlich:</span>
                                    <div class="toggle-buttons">
                                        <button type="button" class="toggle-btn" data-name="osmophobia" data-value="yes">Ja</button>
                                        <button type="button" class="toggle-btn active" data-name="osmophobia" data-value="no">Nein</button>
                                    </div>
                                </div>
                            </div>
                            <input type="hidden" name="vomiting" value="no">
                            <input type="hidden" name="nausea" value="no">
                            <input type="hidden" name="phonophobia" value="no">
                            <input type="hidden" name="photophobia" value="no">
                            <input type="hidden" name="osmophobia" value="no">
                        </div>

                        <div class="form-group">
                            <label>Weitere Symptome:</label>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="otherSymptoms" value="tears">
                                    <span class="checkmark">üò≠</span>
                                    Augentr√§nen
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="otherSymptoms" value="redness">
                                    <span class="checkmark">üëÅÔ∏è</span>
                                    Augenr√∂tung
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="otherSymptoms" value="nose">
                                    <span class="checkmark">üëÉ</span>
                                    Nasenlaufen/-verstopfung
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="otherSymptoms" value="muscle">
                                    <span class="checkmark">üí™</span>
                                    Muskelzucken
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Medication -->
                    <div class="form-section">
                        <h3>Akutmedikation</h3>
                        <div class="form-group">
                            <label>Welche Medikation genommen:</label>
                            <div class="button-group">
                                <button type="button" class="option-btn" data-value="keine">‚ùå<br>Keine</button>
                                <button type="button" class="option-btn" data-value="sumatriptan">üíâ<br>Sumatriptan</button>
                                <button type="button" class="option-btn" data-value="neuralgin">üíä<br>Neuralgin</button>
                                <button type="button" class="option-btn" data-value="andere">üîÑ<br>Andere</button>
                            </div>
                            <input type="hidden" name="medication" required>
                        </div>

                        <div class="medication-details" style="display: none;">
                            <div class="form-group">
                                <label>Anzahl Tabletten/Dosen:</label>
                                <div class="slider-container">
                                    <input type="range" id="medCount" name="medCount" min="0" max="10" step="0.5" value="1" class="med-slider">
                                    <div class="slider-value">
                                        <span id="medCountValue">1</span>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Hat die Medikation geholfen?</label>
                                <div class="button-group">
                                    <button type="button" class="option-btn small" data-value="yes">‚úÖ<br>Ja,<br>geholfen</button>
                                    <button type="button" class="option-btn small" data-value="little">‚ö†Ô∏è<br>Wenig<br>geholfen</button>
                                    <button type="button" class="option-btn small" data-value="no">‚ùå<br>Nicht<br>geholfen</button>
                                </div>
                                <input type="hidden" name="medHelped">
                            </div>
                        </div>
                    </div>

                    <div class="save-button-group">
                        <button type="submit" class="save-btn" disabled id="detailedSaveBtn">
                            ‚ö†Ô∏è Bitte Grunddaten ausf√ºllen
                        </button>
                        <button type="button" class="quick-save-btn" disabled id="quickSaveBtn" onclick="quickSaveEntry()">
                            ‚ö° Schnell speichern
                        </button>
                    </div>
                </form>

                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="showEntries()">üìä Eintr√§ge ansehen</button>
                    <button class="quick-action-btn" onclick="showBackdateForm()">üìÖ Nachtragen</button>
                    <button class="quick-action-btn" onclick="exportData()">üìÅ Export</button>
                </div>
            </div>
        </div>

        <!-- Backdate Entry Screen -->
        <div class="screen" id="backdateScreen">
            <div class="entries-nav">
                <button class="back-btn" onclick="showDetailedForm()">‚Üê Zur√ºck</button>
                <button class="export-btn" onclick="exportData()">üì§ Export</button>
            </div>

            <div class="quick-header">
                <h1>üìÖ Nachtragen</h1>
                <p>Vergangene Attacke dokumentieren</p>
            </div>
            
            <div class="form-container">
                <form id="backdateForm">
                    <div class="form-group">
                        <label>Datum und Uhrzeit:</label>
                        <div class="datetime-input-group">
                            <input type="date" id="backdateDate" required>
                            <input type="time" id="backdateTime" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Art der Beschwerden:</label>
                        <div class="button-group">
                            <button type="button" class="option-btn" data-value="kopfschmerz">ü§ï<br>Kopf-<br>schmerz</button>
                            <button type="button" class="option-btn" data-value="migraene">‚ö°<br>Migr√§ne</button>
                            <button type="button" class="option-btn" data-value="aura">üëÅÔ∏è<br>Aura</button>
                            <button type="button" class="option-btn" data-value="aura-migraene">üåÄ<br>Aura+<br>Migr√§ne</button>
                        </div>
                        <input type="hidden" name="type" required>
                    </div>

                    <div class="form-group">
                        <label>Medikation genommen:</label>
                        <div class="button-group">
                            <button type="button" class="option-btn" data-value="keine">‚ùå<br>Keine</button>
                            <button type="button" class="option-btn" data-value="schmerzmittel">üíä<br>Schmerz-<br>mittel</button>
                            <button type="button" class="option-btn" data-value="triptan">üíâ<br>Triptan</button>
                        </div>
                        <input type="hidden" name="medication" required>
                    </div>

                    <button type="submit" class="save-btn" disabled id="backdateSaveBtn">
                        ‚ö†Ô∏è Bitte alles ausw√§hlen
                    </button>
                </form>

                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="showDetailedForm()">üìã Zur Detailerfassung</button>
                    <button class="quick-action-btn" onclick="showEntries()">üìä Eintr√§ge ansehen</button>
                </div>
            </div>
        </div>

        <!-- Entries Screen -->
        <div class="screen" id="entriesScreen">
            <div class="entries-nav">
                <button class="back-btn" onclick="showDetailedForm()">‚Üê Zur√ºck</button>
                <button class="export-btn" onclick="showBackdateForm()">üìÖ Nachtragen</button>
                <button class="export-btn" onclick="exportData()">üì§ Export</button>
            </div>

            <div class="entries-header">
                <h2>üìä Meine Eintr√§ge</h2>
                <div class="stats" id="statsDisplay">Lade Daten...</div>
            </div>

            <div class="summary-card" id="summaryCard" style="display: none;">
                <div class="summary-grid">
                    <div class="summary-item">
                        <h3 id="totalCount">0</h3>
                        <p>Gesamt</p>
                    </div>
                    <div class="summary-item">
                        <h3 id="thisWeekCount">0</h3>
                        <p>Diese Woche</p>
                    </div>
                    <div class="summary-item">
                        <h3 id="mostCommonType">-</h3>
                        <p>H√§ufigste Art</p>
                    </div>
                </div>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" onclick="setFilter('all')">Alle</button>
                <button class="filter-tab" onclick="setFilter('migraene')">Migr√§ne</button>
                <button class="filter-tab" onclick="setFilter('aura-migraene')">Aura+M</button>
                <button class="filter-tab" onclick="setFilter('kopfschmerz')">Kopfschmerz</button>
                <button class="filter-tab" onclick="setFilter('aura')">Aura</button>
            </div>

            <div class="entries-content">
                <div class="entries-toolbar">
                    <h3>Verlauf</h3>
                    <button class="toolbar-btn" onclick="refreshEntries()">üîÑ Aktualisieren</button>
                </div>
                
                <div class="entries-list" id="entriesList">
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-content">
            <span class="icon">‚úÖ</span>
            Erfolgreich gespeichert!
            <div style="font-size: 16px; margin-top: 15px; opacity: 0.9;" id="successDetails">
                Wird automatisch geschlossen...
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'MigraineDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'entries';
        let db = null;
        let entries = [];
        let currentFilter = 'all';

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB error:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('type', 'type', { unique: false });
                    }
                };
            });
        }

        function showDetailedForm() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('detailedScreen').classList.add('active');
            document.body.className = 'bg-quick';
            
            resetDetailedForm();
            vibrate();
        }

        function showEntries() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('entriesScreen').classList.add('active');
            document.body.className = 'bg-entries';
            refreshEntries();
            vibrate();
        }

        function showBackdateForm() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('backdateScreen').classList.add('active');
            document.body.className = 'bg-quick';
            
            const now = new Date();
            document.getElementById('backdateDate').value = now.toISOString().split('T')[0];
            document.getElementById('backdateTime').value = now.toTimeString().slice(0,5);
            
            document.getElementById('backdateForm').reset();
            document.querySelectorAll('#backdateScreen .option-btn').forEach(btn => btn.classList.remove('selected'));
            updateBackdateSaveButton();
            
            vibrate();
        }

        function resetDetailedForm() {
            document.getElementById('detailedForm').reset();
            document.querySelectorAll('#detailedScreen .option-btn').forEach(btn => btn.classList.remove('selected'));
            document.querySelectorAll('#detailedScreen .toggle-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.value === 'no') btn.classList.add('active');
            });
            
            document.querySelectorAll('#detailedScreen input[type="hidden"]').forEach(input => {
                if (['vomiting', 'nausea', 'phonophobia', 'photophobia', 'osmophobia', 'pulsating', 'pressing'].includes(input.name)) {
                    input.value = 'no';
                } else {
                    input.value = '';
                }
            });
            
            document.getElementById('painLevel').value = 5;
            document.getElementById('duration').value = 4;
            document.getElementById('medCount').value = 1;
            updatePainLevel();
            updateDuration();
            updateMedCount();
            
            document.querySelector('.medication-details').style.display = 'none';
            document.getElementById('quickSaveBtn').style.display = 'block';
            document.getElementById('detailedSaveBtn').textContent = 'üíæ Vollst√§ndig speichern';
            
            updateDetailedSaveButton();
        }

        function updateTimestamp() {
            document.getElementById('timestamp').textContent = 
                new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        }
        setInterval(updateTimestamp, 1000);
        updateTimestamp();

        function vibrate(pattern = 10) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        function saveEntry(entry) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(entry);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function loadEntries() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    entries = request.result || [];
                    entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    updateEntriesCount();
                    resolve(entries);
                };

                request.onerror = () => reject(request.error);
            });
        }

        function deleteEntryFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        function updateEntriesCount() {
            document.getElementById('entriesCount').textContent = `üìä ${entries.length} Eintr√§ge`;
        }

        function updateBackdateSaveButton() {
            const form = document.getElementById('backdateForm');
            const formData = new FormData(form);
            const saveBtn = document.getElementById('backdateSaveBtn');
            const dateValid = document.getElementById('backdateDate').value;
            const timeValid = document.getElementById('backdateTime').value;
            
            const isValid = formData.get('type') && formData.get('medication') && dateValid && timeValid;
            saveBtn.disabled = !isValid;
            
            if (isValid) {
                saveBtn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                saveBtn.style.boxShadow = '0 8px 20px rgba(76, 205, 196, 0.4)';
                saveBtn.textContent = 'üíæ Nachtrag speichern';
            } else {
                saveBtn.style.background = '#ccc';
                saveBtn.style.boxShadow = 'none';
                saveBtn.textContent = '‚ö†Ô∏è Bitte alles ausw√§hlen';
            }
        }

        function updateDetailedSaveButton() {
            const form = document.getElementById('detailedForm');
            const formData = new FormData(form);
            const saveBtn = document.getElementById('detailedSaveBtn');
            const quickSaveBtn = document.getElementById('quickSaveBtn');
            
            const isValid = formData.get('type') && formData.get('medication');
            saveBtn.disabled = !isValid;
            quickSaveBtn.disabled = !isValid;
            
            if (isValid) {
                saveBtn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                saveBtn.style.boxShadow = '0 8px 20px rgba(76, 205, 196, 0.4)';
                if (saveBtn.textContent.includes('√Ñnderungen')) {
                    // Keep edit text
                } else {
                    saveBtn.textContent = 'üíæ Vollst√§ndig speichern';
                }
                
                quickSaveBtn.style.background = 'white';
                quickSaveBtn.style.color = '#ff6b6b';
                quickSaveBtn.style.borderColor = '#ff6b6b';
            } else {
                saveBtn.style.background = '#ccc';
                saveBtn.style.boxShadow = 'none';
                if (saveBtn.textContent.includes('√Ñnderungen')) {
                    saveBtn.textContent = '‚ö†Ô∏è Bitte Grunddaten ausf√ºllen';
                } else {
                    saveBtn.textContent = '‚ö†Ô∏è Bitte Grunddaten ausf√ºllen';
                }
                
                quickSaveBtn.style.background = '#f8f9fa';
                quickSaveBtn.style.color = '#ccc';
                quickSaveBtn.style.borderColor = '#ccc';
            }
        }

        function updatePainLevel() {
            const slider = document.getElementById('painLevel');
            const display = document.getElementById('painLevelValue');
            if (slider && display) {
                display.textContent = slider.value;
                slider.oninput = function() {
                    display.textContent = this.value;
                };
            }
        }

        function updateDuration() {
            const slider = document.getElementById('duration');
            const display = document.getElementById('durationValue');
            if (slider && display) {
                display.textContent = slider.value;
                slider.oninput = function() {
                    display.textContent = this.value;
                };
            }
        }

        function updateMedCount() {
            const slider = document.getElementById('medCount');
            const display = document.getElementById('medCountValue');
            if (slider && display) {
                display.textContent = slider.value;
                slider.oninput = function() {
                    display.textContent = this.value;
                };
            }
        }

        function quickSaveEntry() {
            const form = document.getElementById('detailedForm');
            const formData = new FormData(form);
            
            if (!formData.get('type') || !formData.get('medication')) {
                alert('Bitte w√§hle mindestens Art der Beschwerden und Medikation aus.');
                return;
            }

            vibrate([20, 50, 20]);
            
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: formData.get('type'),
                medication: formData.get('medication'),
                source: 'quickSave',
                version: 2
            };

            saveEntryAndShowSuccess(entry, 'quick');
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option-btn')) {
                vibrate();
                const group = e.target.parentNode;
                const hiddenInput = group.nextElementSibling;
                
                if (e.target.classList.contains('selected')) {
                    e.target.classList.remove('selected');
                    hiddenInput.value = '';
                } else {
                    group.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    hiddenInput.value = e.target.dataset.value;
                }
                
                if (e.target.closest('#backdateScreen')) {
                    updateBackdateSaveButton();
                } else if (e.target.closest('#detailedScreen')) {
                    updateDetailedSaveButton();
                    
                    if (hiddenInput.name === 'medication') {
                        const medDetails = document.querySelector('.medication-details');
                        if (hiddenInput.value && hiddenInput.value !== 'keine') {
                            medDetails.style.display = 'block';
                            medDetails.classList.add('show');
                        } else {
                            medDetails.style.display = 'none';
                            medDetails.classList.remove('show');
                        }
                    }
                }
            }
            
            if (e.target.classList.contains('toggle-btn')) {
                vibrate();
                const group = e.target.parentNode;
                const name = e.target.dataset.name;
                const value = e.target.dataset.value;
                
                group.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                const hiddenInput = document.querySelector(`input[name="${name}"]`);
                if (hiddenInput) {
                    hiddenInput.value = value;
                }
                
                updateDetailedSaveButton();
            }
        });

        document.addEventListener('change', function(e) {
            if (e.target.id === 'backdateDate' || e.target.id === 'backdateTime') {
                updateBackdateSaveButton();
            }
        });

        document.getElementById('detailedForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            vibrate([20, 50, 20]);
            
            const formData = new FormData(e.target);
            
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: formData.get('type'),
                medication: formData.get('medication'),
                trigger: formData.get('trigger') || null,
                painLevel: parseInt(formData.get('painLevel')),
                duration: parseFloat(formData.get('duration')),
                pulsating: formData.get('pulsating') === 'yes',
                pressing: formData.get('pressing') === 'yes',
                location: formData.get('location') || null,
                vomiting: formData.get('vomiting') === 'yes',
                nausea: formData.get('nausea') === 'yes',
                phonophobia: formData.get('phonophobia') === 'yes',
                photophobia: formData.get('photophobia') === 'yes',
                osmophobia: formData.get('osmophobia') === 'yes',
                medCount: formData.get('medication') !== 'keine' ? parseFloat(formData.get('medCount')) : 0,
                medHelped: formData.get('medHelped') || null,
                aura: formData.getAll('aura'),
                otherSymptoms: formData.getAll('otherSymptoms'),
                source: 'detailed',
                version: 3
            };

            saveEntryAndShowSuccess(entry, 'detailed');
        });

        document.getElementById('backdateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            vibrate([20, 50, 20]);
            
            const formData = new FormData(e.target);
            const date = document.getElementById('backdateDate').value;
            const time = document.getElementById('backdateTime').value;
            
            const timestamp = new Date(`${date}T${time}`).toISOString();
            
            const entry = {
                id: Date.now() + Math.random(),
                timestamp: timestamp,
                type: formData.get('type'),
                medication: formData.get('medication'),
                source: 'backdate',
                version: 2
            };

            saveEntryAndShowSuccess(entry, 'backdate');
        });

        async function saveEntryAndShowSuccess(entry, type) {
            try {
                await saveEntry(entry);
                await loadEntries();
                
                let successMessage = '';
                switch(type) {
                    case 'quick':
                        successMessage = `<strong>‚ö° Schnell gespeichert!</strong>`;
                        break;
                    case 'detailed':
                        successMessage = `<strong>üìã Vollst√§ndig gespeichert!</strong>`;
                        break;
                    case 'backdate':
                        successMessage = `<strong>üìÖ Nachtrag erfolgreich!</strong>`;
                        break;
                }
                
                document.getElementById('successDetails').innerHTML = `
                    ${successMessage}<br>
                    ${getTypeLabel(entry.type)}<br>
                    ${getMedicationLabel(entry.medication)}<br>
                    <small>${new Date(entry.timestamp).toLocaleString('de-DE')}</small>
                `;
                document.getElementById('successOverlay').style.display = 'flex';
                
                setTimeout(() => {
                    document.getElementById('successOverlay').style.display = 'none';
                    if (type === 'backdate') {
                        showDetailedForm();
                    } else {
                        resetDetailedForm();
                    }
                }, 3000);
                
                vibrate([100, 50, 100]);
                
            } catch (error) {
                console.error('Save error:', error);
                alert('Speichern fehlgeschlagen. Bitte versuche es erneut.');
                vibrate([200, 100, 200, 100, 200]);
            }
        }

        function refreshEntries() {
            loadEntries().then(() => {
                calculateStats();
                renderEntries();
            }).catch(error => {
                console.error('Load error:', error);
            });
        }

        function calculateStats() {
            if (entries.length === 0) {
                document.getElementById('summaryCard').style.display = 'none';
                document.getElementById('statsDisplay').textContent = 'Keine Eintr√§ge vorhanden';
                return;
            }

            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const thisWeekEntries = entries.filter(entry => 
                new Date(entry.timestamp) >= weekAgo
            );

            const typeCounts = {};
            entries.forEach(entry => {
                typeCounts[entry.type] = (typeCounts[entry.type] || 0) + 1;
            });

            let mostCommonType = '-';
            if (Object.keys(typeCounts).length > 0) {
                const mostCommon = Object.keys(typeCounts).reduce((a, b) => 
                    typeCounts[a] > typeCounts[b] ? a : b
                );
                mostCommonType = getTypeLabel(mostCommon).split(' ')[0];
            }

            document.getElementById('totalCount').textContent = entries.length;
            document.getElementById('thisWeekCount').textContent = thisWeekEntries.length;
            document.getElementById('mostCommonType').textContent = mostCommonType;
            document.getElementById('statsDisplay').textContent = 
                `${entries.length} Eintr√§ge ‚Ä¢ ${thisWeekEntries.length} diese Woche`;
            document.getElementById('summaryCard').style.display = 'block';
        }

        function setFilter(filter) {
            vibrate();
            currentFilter = filter;
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderEntries();
        }

        function renderEntries() {
            const container = document.getElementById('entriesList');
            
            let filteredEntries = entries;
            if (currentFilter !== 'all') {
                filteredEntries = entries.filter(entry => entry.type === currentFilter);
            }

            if (filteredEntries.length === 0) {
                const filterText = currentFilter === 'all' ? '' : ` f√ºr "${getTypeLabel(currentFilter)}"`;
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üìù</div>
                        <h3>Keine Eintr√§ge vorhanden${filterText}</h3>
                        <p>Nutze die Detailerfassung!</p>
                    </div>
                `;
                return;
            }

            const sortedEntries = filteredEntries.sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            container.innerHTML = sortedEntries.map(entry => {
                const { dateText, timeText, relativeText } = formatDateTime(entry.timestamp);
                
                return `
                    <div class="entry">
                        <div class="entry-header">
                            <div>
                                <div class="entry-date">${dateText}</div>
                                <div class="entry-time">${timeText}</div>
                            </div>
                            <div class="entry-actions">
                                <button class="edit-btn" onclick="editEntry(${entry.id})">‚úèÔ∏è</button>
                                <button class="delete-btn" onclick="deleteEntry(${entry.id})">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="entry-details">
                            <div class="detail-item">
                                <div class="detail-label">Art</div>
                                <div class="detail-value">${getTypeLabel(entry.type)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Medikation</div>
                                <div class="detail-value">${getMedicationLabel(entry.medication)}</div>
                            </div>
                        </div>
                        <div class="entry-relative-time">${relativeText}</div>
                    </div>
                `;
            }).join('');
        }

        async function deleteEntry(id) {
            if (confirm('Eintrag wirklich l√∂schen?')) {
                vibrate([20, 50, 20]);
                try {
                    await deleteEntryFromDB(id);
                    await loadEntries();
                    calculateStats();
                    renderEntries();
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('L√∂schen fehlgeschlagen.');
                }
            }
        }

        async function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            // For now, simple edit - later we can expand this
            showDetailedForm();
            
            setTimeout(() => {
                // Basic population - can be expanded
                if (entry.type) {
                    const typeBtn = document.querySelector(`#detailedScreen [data-value="${entry.type}"]`);
                    if (typeBtn) typeBtn.click();
                }
                
                if (entry.medication) {
                    let medValue = entry.medication;
                    if (medValue === 'schmerzmittel') medValue = 'neuralgin';
                    if (medValue === 'triptan') medValue = 'sumatriptan';
                    
                    const medBtn = document.querySelector(`#detailedScreen [data-value="${medValue}"]`);
                    if (medBtn && medBtn.closest('.form-group').querySelector('label').textContent.includes('Medikation')) {
                        medBtn.click();
                    }
                }
            }, 100);
        }

        function exportData() {
            if (entries.length === 0) {
                alert('Keine Daten zum Exportieren vorhanden.');
                return;
            }

            vibrate();

            const choice = confirm('M√∂chtest du einen visuellen Jahreskalender erstellen?\n\nOK = Jahreskalender (HTML)\nAbbrechen = Daten-Backup (JSON)');
            
            if (choice) {
                generateYearlyReport();
            } else {
                exportJSONData();
            }
        }

        function exportJSONData() {
            try {
                const exportData = {
                    app: 'Migr√§ne Tagebuch',
                    version: '3.0',
                    exported: new Date().toISOString(),
                    entryCount: entries.length,
                    entries: entries
                };

                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `migraene-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Export error:', error);
            }
        }

        function generateYearlyReport() {
            const currentYear = new Date().getFullYear();
            const yearEntries = entries.filter(entry => 
                new Date(entry.timestamp).getFullYear() === currentYear
            );

            if (yearEntries.length === 0) {
                alert(`Keine Eintr√§ge f√ºr ${currentYear} gefunden.`);
                return;
            }

            alert('Jahreskalender wird erstellt... (vereinfachte Version)');
        }

        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffTime / (1000 * 60));

            let dateText, timeText, relativeText;

            if (diffDays === 0) {
                dateText = 'Heute';
            } else if (diffDays === 1) {
                dateText = 'Gestern';
            } else if (diffDays < 7) {
                dateText = date.toLocaleDateString('de-DE', { weekday: 'long' });
            } else {
                dateText = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            }

            timeText = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            if (diffMinutes < 60) {
                relativeText = `vor ${diffMinutes} Min`;
            } else if (diffHours < 24) {
                relativeText = `vor ${diffHours} Std`;
            } else {
                relativeText = `vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
            }

            return { dateText, timeText, relativeText };
        }

        function getTypeLabel(type) {
            const labels = {
                'kopfschmerz': 'ü§ï Kopfschmerz',
                'migraene': '‚ö° Migr√§ne',
                'aura': 'üëÅÔ∏è Aura',
                'aura-migraene': 'üåÄ Aura + Migr√§ne'
            };
            return labels[type] || type;
        }

        function getMedicationLabel(medication) {
            const labels = {
                'keine': '‚ùå Keine',
                'schmerzmittel': 'üíä Schmerzmittel',
                'triptan': 'üíâ Triptan',
                'sumatriptan': 'üíâ Sumatriptan',
                'neuralgin': 'üíä Neuralgin',
                'andere': 'üîÑ Andere'
            };
            return labels[medication] || medication;
        }

        window.addEventListener('load', async function() {
            try {
                await initDB();
                await loadEntries();
                updateBackdateSaveButton();
                updateDetailedSaveButton();
                
                updatePainLevel();
                updateDuration();
                updateMedCount();
                
                const oldData = localStorage.getItem('migraineEntries');
                if (oldData && entries.length === 0) {
                    try {
                        const oldEntries = JSON.parse(oldData);
                        for (const entry of oldEntries) {
                            await saveEntry(entry);
                        }
                        await loadEntries();
                        localStorage.removeItem('migraineEntries');
                    } catch (e) {
                        console.warn('Migration failed:', e);
                    }
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>