<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ff6b6b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Migräne ⚡">
    <title>Migräne ⚡ Schnelleingabe</title>
    
    <!-- PWA Icons -->
    <link rel="apple-touch-icon" href="migraine-quick-glow.png">
    <link rel="icon" href="migraine-quick-glow.png">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiTWlncsOkbmUg4pqhIFNjaG5lbGxlaW5nYWJlIiwic2hvcnRfbmFtZSI6Ik1pZ3LkbmUg4pqhIiwiZGVzY3JpcHRpb24iOiJTY2huZWxsZSBFaW5nYWJlIGbDvHIgTWlncsOkbmUtQXR0YWNrZW4iLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmNmI2YiIsInRoZW1lX2NvbG9yIjoiI2ZmNmI2YiIsImljb25zIjpbeyJzcmMiOiJtaWdyYWluZS1xdWljay1nbG93LnBuZyIsInNpemVzIjoiMTgweDE4MCIsInR5cGUiOiJpbWFnZS9wbmcifV19">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: env(safe-area-inset-top, 20px) 20px env(safe-area-inset-bottom, 20px) 20px;
            user-select: none;
            -webkit-user-select: none;
            color: white;
            transition: background 0.3s ease;
            /* FIXED: Removed overflow: hidden to allow scrolling */
        }

        /* Dynamic backgrounds */
        .bg-quick {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .bg-entries {
            background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        }

        .container {
            max-width: 450px;
            margin: 0 auto;
            width: 100%;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Top Status Bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .timestamp {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 500;
        }

        .entries-count {
            font-size: 12px;
            opacity: 0.8;
            background: rgba(255,255,255,0.2);
            padding: 6px 12px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entries-count:active {
            transform: scale(0.95);
        }

        /* Screens */
        .screen {
            display: none;
            flex: 1;
            animation: slideIn 0.3s ease-out;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Quick Entry Screen */
        .quick-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .quick-header h1 {
            font-size: 42px;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .quick-header p {
            font-size: 18px;
            opacity: 0.9;
        }

        .form-container {
            background: rgba(255,255,255,0.95);
            border-radius: 25px;
            padding: 40px 30px;
            color: #333;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 15px;
            font-weight: 700;
            font-size: 18px;
            color: #333;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (max-width: 450px) {
            .button-group {
                grid-template-columns: 1fr;
                gap: 10px;
            }
        }

        @media (max-width: 350px) {
            .button-group {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
        }

        .option-btn {
            padding: 16px 8px;
            border: 3px solid #f0f0f0;
            border-radius: 15px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            touch-action: manipulation;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            line-height: 1.1;
            min-height: 80px;
            max-height: 90px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            word-break: break-word;
            hyphens: auto;
        }

        @media (max-width: 380px) {
            .option-btn {
                font-size: 12px;
                padding: 12px 6px;
                min-height: 75px;
            }
        }

        @media (max-width: 320px) {
            .option-btn {
                font-size: 11px;
                padding: 10px 4px;
                min-height: 70px;
                line-height: 1.0;
            }
        }

        .option-btn:active {
            transform: scale(0.95);
        }

        .option-btn.selected {
            border-color: #ff6b6b;
            background: #ff6b6b;
            color: white;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            transform: translateY(-2px);
        }

        .save-btn {
            width: 100%;
            padding: 22px;
            border: none;
            border-radius: 15px;
            font-size: 20px;
            font-weight: 700;
            cursor: pointer;
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
            color: white;
            box-shadow: 0 8px 20px rgba(76, 205, 196, 0.4);
            transition: all 0.3s ease;
            touch-action: manipulation;
            margin-top: auto;
            margin-bottom: 20px;
        }

        .save-btn:active {
            transform: scale(0.98);
        }

        .save-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background: #ccc;
            box-shadow: none;
        }

        .quick-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .quick-action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .quick-action-btn:active {
            transform: scale(0.95);
        }

        /* Entries Screen */
        .entries-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .back-btn:active {
            transform: scale(0.95);
        }

        .export-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 12px;
            padding: 10px 20px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s ease;
        }

        .export-btn:active {
            transform: scale(0.95);
        }

        .entries-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .entries-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .entries-header .stats {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            display: inline-block;
        }

        .summary-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .summary-item h3 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .summary-item p {
            font-size: 12px;
            opacity: 0.9;
        }

        .filter-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .filter-tabs::-webkit-scrollbar {
            display: none;
        }

        .filter-tab {
            flex: 0 0 auto;
            min-width: 60px;
            max-width: 80px;
            padding: 8px 6px;
            border: none;
            border-radius: 16px;
            background: rgba(255,255,255,0.3);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .filter-tab.active {
            background: white;
            color: #4ecdc4;
        }

        .entries-content {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            /* FIXED: Changed overflow to auto to allow scrolling when needed */
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            /* IMPROVED: Added max-height to prevent issues on very tall screens */
            max-height: 70vh;
        }

        .entries-toolbar {
            padding: 20px 25px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            /* ADDED: Keep toolbar sticky at top */
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .entries-toolbar h3 {
            color: #333;
            font-size: 18px;
            margin: 0;
        }

        .toolbar-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            background: #4ecdc4;
            color: white;
        }

        .entries-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px 25px;
            /* IMPROVED: Better scrolling behavior */
            -webkit-overflow-scrolling: touch;
        }

        .entry {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 5px solid #4ecdc4;
            transition: all 0.2s ease;
        }

        .entry:active {
            transform: scale(0.98);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .entry-date {
            font-weight: 700;
            color: #333;
            font-size: 16px;
        }

        .entry-time {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .entry-actions {
            display: flex;
            gap: 8px;
        }

        .entry-actions button {
            padding: 5px 8px;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            touch-action: manipulation;
            min-width: 28px;
        }

        .edit-btn {
            background: #ffd93d;
            color: #333;
        }

        .delete-btn {
            background: #ff6b6b;
            color: white;
        }

        .entry-details {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .detail-item {
            flex: 1;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 15px;
            color: #333;
            font-weight: 600;
        }

        .entry-relative-time {
            font-size: 12px;
            color: #999;
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 60px 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Success overlay */
        .success-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(76, 175, 80, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
            text-align: center;
        }

        .success-content {
            font-size: 24px;
            font-weight: 700;
        }

        .success-content .icon {
            font-size: 80px;
            margin-bottom: 20px;
            display: block;
        }

        @media (max-width: 480px) {
            .entry-details {
                flex-direction: column;
                gap: 10px;
            }
            
            .summary-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
        }
    </style>
</head>
<body class="bg-quick">
    <div class="container">
        <!-- Status Bar -->
        <div class="status-bar">
            <div class="timestamp" id="timestamp"></div>
            <div class="entries-count" id="entriesCount" onclick="showEntries()">📊 0 Einträge</div>
        </div>

        <!-- Quick Entry Screen (Default) -->
        <div class="screen active" id="quickEntryScreen">
            <div class="quick-header">
                <h1>⚡ Schnelleingabe</h1>
                <p>Sofort dokumentieren</p>
            </div>
            
            <div class="form-container">
                <form id="quickForm">
                    <div class="form-group">
                        <label>Art der Beschwerden:</label>
                        <div class="button-group">
                            <button type="button" class="option-btn" data-value="kopfschmerz">🤕<br>Kopf-<br>schmerz</button>
                            <button type="button" class="option-btn" data-value="migraene">⚡<br>Migräne</button>
                            <button type="button" class="option-btn" data-value="aura">👁️<br>Aura</button>
                            <button type="button" class="option-btn" data-value="aura-migraene">🌀<br>Aura+<br>Migräne</button>
                        </div>
                        <input type="hidden" name="type" required>
                    </div>

                    <div class="form-group">
                        <label>Medikation genommen:</label>
                        <div class="button-group">
                            <button type="button" class="option-btn" data-value="keine">❌<br>Keine</button>
                            <button type="button" class="option-btn" data-value="schmerzmittel">💊<br>Schmerz-<br>mittel</button>
                            <button type="button" class="option-btn" data-value="triptan">💉<br>Triptan</button>
                        </div>
                        <input type="hidden" name="medication" required>
                    </div>

                    <button type="submit" class="save-btn" disabled id="saveBtn">
                        ⚠️ Bitte alles auswählen
                    </button>
                </form>

                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="showEntries()">📊 Einträge ansehen</button>
                    <button class="quick-action-btn" onclick="exportData()">📁 Export</button>
                </div>
            </div>
        </div>

        <!-- Entries Screen -->
        <div class="screen" id="entriesScreen">
            <div class="entries-nav">
                <button class="back-btn" onclick="showQuickEntry()">← Zurück</button>
                <button class="export-btn" onclick="exportData()">📤 Export</button>
            </div>

            <div class="entries-header">
                <h2>📊 Meine Einträge</h2>
                <div class="stats" id="statsDisplay">Lade Daten...</div>
            </div>

            <div class="summary-card" id="summaryCard" style="display: none;">
                <div class="summary-grid">
                    <div class="summary-item">
                        <h3 id="totalCount">0</h3>
                        <p>Gesamt</p>
                    </div>
                    <div class="summary-item">
                        <h3 id="thisWeekCount">0</h3>
                        <p>Diese Woche</p>
                    </div>
                    <div class="summary-item">
                        <h3 id="mostCommonType">-</h3>
                        <p>Häufigste Art</p>
                    </div>
                </div>
            </div>

            <div class="filter-tabs">
                <button class="filter-tab active" onclick="setFilter('all')">Alle</button>
                <button class="filter-tab" onclick="setFilter('migraene')">Migräne</button>
                <button class="filter-tab" onclick="setFilter('aura-migraene')">Aura+M</button>
                <button class="filter-tab" onclick="setFilter('kopfschmerz')">Kopfschmerz</button>
                <button class="filter-tab" onclick="setFilter('aura')">Aura</button>
            </div>

            <div class="entries-content">
                <div class="entries-toolbar">
                    <h3>Verlauf</h3>
                    <button class="toolbar-btn" onclick="refreshEntries()">🔄 Aktualisieren</button>
                </div>
                
                <div class="entries-list" id="entriesList">
                    <!-- Entries will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-content">
            <span class="icon">✅</span>
            Erfolgreich gespeichert!
            <div style="font-size: 16px; margin-top: 15px; opacity: 0.9;" id="successDetails">
                Wird automatisch geschlossen...
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'MigraineDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'entries';
        let db = null;
        let entries = [];
        let currentFilter = 'all';

        // IndexedDB Setup
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('IndexedDB error:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('type', 'type', { unique: false });
                    }
                };
            });
        }

        // Navigation
        function showQuickEntry() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('quickEntryScreen').classList.add('active');
            document.body.className = 'bg-quick';
            vibrate();
        }

        function showEntries() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('entriesScreen').classList.add('active');
            document.body.className = 'bg-entries';
            refreshEntries();
            vibrate();
        }

        // Update timestamp
        function updateTimestamp() {
            document.getElementById('timestamp').textContent = 
                new Date().toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'});
        }
        setInterval(updateTimestamp, 1000);
        updateTimestamp();

        // Haptic feedback
        function vibrate(pattern = 10) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // Database operations
        function saveEntry(entry) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(entry);

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        function loadEntries() {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    entries = request.result || [];
                    entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    updateEntriesCount();
                    resolve(entries);
                };

                request.onerror = () => reject(request.error);
            });
        }

        function deleteEntryFromDB(id) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('Database not initialized'));
                    return;
                }

                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // Update entries count
        function updateEntriesCount() {
            document.getElementById('entriesCount').textContent = `📊 ${entries.length} Einträge`;
        }

        // Quick Entry Form handling
        function updateSaveButton() {
            const form = document.getElementById('quickForm');
            const formData = new FormData(form);
            const saveBtn = document.getElementById('saveBtn');
            
            const isValid = formData.get('type') && formData.get('medication');
            saveBtn.disabled = !isValid;
            
            if (isValid) {
                saveBtn.style.background = 'linear-gradient(45deg, #4ecdc4, #44a08d)';
                saveBtn.style.boxShadow = '0 8px 20px rgba(76, 205, 196, 0.4)';
                saveBtn.textContent = '💾 Jetzt speichern';
            } else {
                saveBtn.style.background = '#ccc';
                saveBtn.style.boxShadow = 'none';
                saveBtn.textContent = '⚠️ Bitte alles auswählen';
            }
        }

        // Option button handling
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('option-btn')) {
                vibrate();
                const group = e.target.parentNode;
                const hiddenInput = group.nextElementSibling;
                
                if (e.target.classList.contains('selected')) {
                    e.target.classList.remove('selected');
                    hiddenInput.value = '';
                } else {
                    group.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                    e.target.classList.add('selected');
                    hiddenInput.value = e.target.dataset.value;
                }
                
                updateSaveButton();
            }
        });

        // Form submission
        document.getElementById('quickForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            vibrate([20, 50, 20]);
            
            const formData = new FormData(e.target);
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                type: formData.get('type'),
                medication: formData.get('medication'),
                source: 'quickEntry',
                version: 2
            };

            try {
                await saveEntry(entry);
                entries.unshift(entry);
                updateEntriesCount();
                
                // Show success
                document.getElementById('successDetails').innerHTML = `
                    <strong>${getTypeLabel(entry.type)}</strong><br>
                    ${getMedicationLabel(entry.medication)}<br>
                    <small>${new Date().toLocaleString('de-DE')}</small>
                `;
                document.getElementById('successOverlay').style.display = 'flex';
                
                // Reset form
                setTimeout(() => {
                    document.getElementById('successOverlay').style.display = 'none';
                    e.target.reset();
                    document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                    updateSaveButton();
                }, 3000);
                
                vibrate([100, 50, 100]);
                
            } catch (error) {
                console.error('Save error:', error);
                alert('Speichern fehlgeschlagen. Bitte versuche es erneut.');
                vibrate([200, 100, 200, 100, 200]);
            }
        });

        // Entries management
        function refreshEntries() {
            loadEntries().then(() => {
                calculateStats();
                renderEntries();
            }).catch(error => {
                console.error('Load error:', error);
            });
        }

        function calculateStats() {
            if (entries.length === 0) {
                document.getElementById('summaryCard').style.display = 'none';
                document.getElementById('statsDisplay').textContent = 'Keine Einträge vorhanden';
                return;
            }

            const now = new Date();
            const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            const thisWeekEntries = entries.filter(entry => 
                new Date(entry.timestamp) >= weekAgo
            );

            const typeCounts = {};
            entries.forEach(entry => {
                typeCounts[entry.type] = (typeCounts[entry.type] || 0) + 1;
            });

            let mostCommonType = '-';
            if (Object.keys(typeCounts).length > 0) {
                const mostCommon = Object.keys(typeCounts).reduce((a, b) => 
                    typeCounts[a] > typeCounts[b] ? a : b
                );
                mostCommonType = getTypeLabel(mostCommon).split(' ')[0];
            }

            document.getElementById('totalCount').textContent = entries.length;
            document.getElementById('thisWeekCount').textContent = thisWeekEntries.length;
            document.getElementById('mostCommonType').textContent = mostCommonType;
            document.getElementById('statsDisplay').textContent = 
                `${entries.length} Einträge • ${thisWeekEntries.length} diese Woche`;
            document.getElementById('summaryCard').style.display = 'block';
        }

        function setFilter(filter) {
            vibrate();
            currentFilter = filter;
            
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderEntries();
        }

        function renderEntries() {
            const container = document.getElementById('entriesList');
            
            let filteredEntries = entries;
            if (currentFilter !== 'all') {
                filteredEntries = entries.filter(entry => entry.type === currentFilter);
            }

            if (filteredEntries.length === 0) {
                const filterText = currentFilter === 'all' ? '' : ` für "${getTypeLabel(currentFilter)}"`;
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📝</div>
                        <h3>Keine Einträge vorhanden${filterText}</h3>
                        <p>Nutze die Schnelleingabe!</p>
                    </div>
                `;
                return;
            }

            const sortedEntries = filteredEntries.sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            container.innerHTML = sortedEntries.map(entry => {
                const { dateText, timeText, relativeText } = formatDateTime(entry.timestamp);
                
                return `
                    <div class="entry">
                        <div class="entry-header">
                            <div>
                                <div class="entry-date">${dateText}</div>
                                <div class="entry-time">${timeText}</div>
                            </div>
                            <div class="entry-actions">
                                <button class="edit-btn" onclick="editEntry(${entry.id})">✏️</button>
                                <button class="delete-btn" onclick="deleteEntry(${entry.id})">🗑️</button>
                            </div>
                        </div>
                        <div class="entry-details">
                            <div class="detail-item">
                                <div class="detail-label">Art</div>
                                <div class="detail-value">${getTypeLabel(entry.type)}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Medikation</div>
                                <div class="detail-value">${getMedicationLabel(entry.medication)}</div>
                            </div>
                        </div>
                        <div class="entry-relative-time">${relativeText}</div>
                    </div>
                `;
            }).join('');
        }

        async function deleteEntry(id) {
            if (confirm('Eintrag wirklich löschen?')) {
                vibrate([20, 50, 20]);
                try {
                    await deleteEntryFromDB(id);
                    await loadEntries();
                    calculateStats();
                    renderEntries();
                } catch (error) {
                    console.error('Delete error:', error);
                    alert('Löschen fehlgeschlagen.');
                }
            }
        }

        async function editEntry(id) {
            const entry = entries.find(e => e.id === id);
            if (!entry) return;

            const types = ['kopfschmerz', 'migraene', 'aura', 'aura-migraene'];
            const medications = ['keine', 'schmerzmittel', 'triptan'];

            const newType = prompt(
                `Art ändern:\n1 = Kopfschmerz\n2 = Migräne\n3 = Aura\n4 = Aura + Migräne\n\nAktuell: ${getTypeLabel(entry.type)}`,
                types.indexOf(entry.type) + 1
            );

            if (newType && newType >= 1 && newType <= 4) {
                const newMed = prompt(
                    `Medikation ändern:\n1 = Keine\n2 = Schmerzmittel\n3 = Triptan\n\nAktuell: ${getMedicationLabel(entry.medication)}`,
                    medications.indexOf(entry.medication) + 1
                );

                if (newMed && newMed >= 1 && newMed <= 3) {
                    entry.type = types[newType - 1];
                    entry.medication = medications[newMed - 1];
                    
                    try {
                        await saveEntry(entry);
                        calculateStats();
                        renderEntries();
                        vibrate();
                    } catch (error) {
                        console.error('Edit error:', error);
                        alert('Bearbeiten fehlgeschlagen.');
                    }
                }
            }
        }

        function exportData() {
            if (entries.length === 0) {
                alert('Keine Daten zum Exportieren vorhanden.');
                return;
            }

            vibrate();

            try {
                const exportData = {
                    app: 'Migräne Tagebuch',
                    version: '2.0',
                    exported: new Date().toISOString(),
                    entryCount: entries.length,
                    entries: entries
                };

                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `migraene-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
            } catch (error) {
                console.error('Export error:', error);
            }
        }

        // Helper functions
        function formatDateTime(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffMinutes = Math.floor(diffTime / (1000 * 60));

            let dateText, timeText, relativeText;

            if (diffDays === 0) {
                dateText = 'Heute';
            } else if (diffDays === 1) {
                dateText = 'Gestern';
            } else if (diffDays < 7) {
                dateText = date.toLocaleDateString('de-DE', { weekday: 'long' });
            } else {
                dateText = date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
            }

            timeText = date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

            if (diffMinutes < 60) {
                relativeText = `vor ${diffMinutes} Min`;
            } else if (diffHours < 24) {
                relativeText = `vor ${diffHours} Std`;
            } else {
                relativeText = `vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
            }

            return { dateText, timeText, relativeText };
        }

        function getTypeLabel(type) {
            const labels = {
                'kopfschmerz': '🤕 Kopfschmerz',
                'migraene': '⚡ Migräne',
                'aura': '👁️ Aura',
                'aura-migraene': '🌀 Aura + Migräne'
            };
            return labels[type] || type;
        }

        function getMedicationLabel(medication) {
            const labels = {
                'keine': '❌ Keine',
                'schmerzmittel': '💊 Schmerzmittel',
                'triptan': '💉 Triptan'
            };
            return labels[medication] || medication;
        }

        // Initialize app
        window.addEventListener('load', async function() {
            try {
                await initDB();
                await loadEntries();
                updateSaveButton();
                
                // Migrate from localStorage if needed
                const oldData = localStorage.getItem('migraineEntries');
                if (oldData && entries.length === 0) {
                    try {
                        const oldEntries = JSON.parse(oldData);
                        for (const entry of oldEntries) {
                            await saveEntry(entry);
                        }
                        await loadEntries();
                        localStorage.removeItem('migraineEntries');
                    } catch (e) {
                        console.warn('Migration failed:', e);
                    }
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        // Prevent zoom on double tap
        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault();
            }
            lastTouchEnd = now;
        }, false);
    </script>
</body>
</html>